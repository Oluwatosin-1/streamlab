{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container-fluid my-3">
  <h2 class="mb-3">Streamlab Studio</h2>
  {% if record_mode %}
    <p class="text-muted">Local Recording Mode: Preview and record your session without live streaming.</p>
  {% else %}
    <p class="text-muted">
      Live Streaming Mode: Preview your camera feed, adjust layouts, switch between cameras or screen share, and go live with connected platforms.
    </p>
  {% endif %}
  <p><small>Session ID: {{ session_uuid }}</small></p>
  
  <div class="row">
    <!-- Left Column: Live Feed & Preview -->
    <div class="col-lg-8">
      <!-- Live Feed Area -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Live Feed</h5>
          <span class="badge bg-success" id="live-status">Initializing...</span>
        </div>
        <div class="card-body bg-dark text-white p-0 position-relative">
          <!-- Live Video Element -->
          <video id="liveVideo" autoplay playsinline muted style="width: 100%; aspect-ratio: 16/9; object-fit: cover;"></video>
          <div id="noLiveText" class="position-absolute top-50 start-50 translate-middle text-white" style="display: none;">
            <h6>No live feed available.</h6>
          </div>
        </div>
      </div>
      
      <!-- Preview Area -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Preview Feed</h5>
          <span class="badge bg-info" id="preview-status">Initializing...</span>
        </div>
        <div class="card-body bg-dark text-white p-0 position-relative">
          <!-- Preview Video Element -->
          <video id="previewVideo" autoplay playsinline muted style="width: 100%; aspect-ratio: 16/9; object-fit: cover;"></video>
          <div id="noPreviewText" class="position-absolute top-50 start-50 translate-middle text-white" style="display: none;">
            <h6>No alternate camera available.</h6>
          </div>
        </div>
      </div>
      
      <!-- Camera Controls -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Camera Controls</h6>
        </div>
        <div class="card-body">
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="stopLiveCamBtn">Stop Live Cam</button>
            <button class="btn btn-outline-primary btn-sm" id="startLiveCamBtn">Start Live Cam</button>
            <button class="btn btn-outline-info btn-sm" id="switchScreenBtn">Share Screen</button>
          </div>
          <div class="mt-2">
            <label for="liveCameraSelect" class="form-label me-2">Live Camera:</label>
            <select id="liveCameraSelect" class="form-select form-select-sm d-inline-block" style="width: auto;"></select>
          </div>
          <div class="mt-2">
            <label for="previewCameraSelect" class="form-label me-2">Preview Camera:</label>
            <select id="previewCameraSelect" class="form-select form-select-sm d-inline-block" style="width: auto;"></select>
          </div>
        </div>
      </div>
      
      <!-- Overlays & Effects -->
      <div class="card mb-3">
        <div class="card-header">
          <h6 class="mb-0">Overlays & Effects</h6>
        </div>
        <div class="card-body">
          <p>Manage overlays, add text/images, or switch scenes. Changes apply immediately to your preview.</p>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm" id="addOverlayBtn">Add Overlay</button>
            <button class="btn btn-outline-secondary btn-sm" id="editOverlayBtn">Edit Overlays</button>
            <button class="btn btn-outline-danger btn-sm" id="removeOverlayBtn">Remove Overlay</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Right Column: Chat and Participants (if not in record mode) -->
    <div class="col-lg-4">
      {% if not record_mode %}
      <!-- Live Chat Section -->
      <div class="card mb-3" style="max-height: 300px;">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Live Chat</h6>
          <button class="btn btn-sm btn-outline-primary" id="refreshChatBtn">Refresh</button>
        </div>
        <div class="card-body" id="chatContainer" style="overflow-y: auto;">
          <p class="text-muted">Chat messages will appear here.</p>
        </div>
        <div class="card-footer">
          <div class="input-group">
            <input type="text" class="form-control" placeholder="Type a message..." id="chatMessage">
            <button class="btn btn-primary" id="sendChatBtn">Send</button>
          </div>
        </div>
      </div>
      {% endif %}
      <!-- Participants / Scenes -->
      <div class="card" style="max-height: 300px;">
        <div class="card-header">
          <h6 class="mb-0">Participants / Scenes</h6>
        </div>
        <div class="card-body" style="overflow-y: auto;">
          <ul class="list-group" id="participantsList">
            <li class="list-group-item d-flex justify-content-between align-items-center">
              Host (You)
              <span class="badge bg-success">Camera On</span>
            </li>
            <!-- Additional participants will be loaded dynamically -->
          </ul>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Footer Toolbar -->
  <div class="d-flex flex-wrap justify-content-end gap-2 mt-3">
    {% if not record_mode and social_accounts|length > 0 and config %}
      <form method="post" action="{% url 'streaming:go_live' %}">
        {% csrf_token %}
        <button class="btn btn-success" id="goLiveBtn">Go Live</button>
      </form>
      <form method="post" action="{% url 'streaming:stop_live' %}">
        {% csrf_token %}
        <button class="btn btn-danger" id="stopLiveBtn">Stop Live</button>
      </form>
    {% endif %}
    <!-- Local Record Controls Always Available -->
    <button class="btn btn-outline-info" id="startRecordBtn">Start Recording</button>
    <button class="btn btn-outline-warning" id="stopRecordBtn" disabled>Stop Recording</button>
  </div>
</div>

<!-- JavaScript for handling cameras, preview, recording, chat, and layout switching -->
<script>
  let liveVideo = document.getElementById("liveVideo");
  let previewVideo = document.getElementById("previewVideo");
  let noCameraText = document.getElementById("noCameraText");
  let streamStatus = document.getElementById("live-status");

  let stopLiveCamBtn = document.getElementById("stopLiveCamBtn");
  let startLiveCamBtn = document.getElementById("startLiveCamBtn");
  let switchScreenBtn = document.getElementById("switchScreenBtn");
  let adjustLayoutBtn = document.getElementById("adjustLayoutBtn");
  let goLiveBtn = document.getElementById("goLiveBtn");
  let stopLiveBtn = document.getElementById("stopLiveBtn");
  let startRecordBtn = document.getElementById("startRecordBtn");
  let stopRecordBtn = document.getElementById("stopRecordBtn");

  // Chat elements (if applicable)
  let refreshChatBtn = document.getElementById("refreshChatBtn");
  let chatContainer = document.getElementById("chatContainer");
  let sendChatBtn = document.getElementById("sendChatBtn");
  let chatMessage = document.getElementById("chatMessage");

  let liveStream = null;   // For the live feed (could be camera or screen share)
  let previewStream = null; // For the alternate preview camera
  let mediaRecorder = null;
  let recordedChunks = [];

  // Unique session UUID from the view
  const sessionUuid = "{{ session_uuid }}";

  // Array to store video devices
  let videoDevices = [];
  let currentLiveDeviceId = null;
  let currentPreviewDeviceId = null;

  // Populate camera select dropdowns (if available)
  async function getVideoDevices() {
    try {
      const devices = await navigator.mediaDevices.enumerateDevices();
      videoDevices = devices.filter(device => device.kind === "videoinput");
      populateCameraSelect("liveCameraSelect", device => {
        // Choose live camera: default first device
        if (!currentLiveDeviceId) currentLiveDeviceId = device.deviceId;
      });
      populateCameraSelect("previewCameraSelect", device => {
        // Choose preview camera: if more than one, pick second; else leave null.
        if (videoDevices.length > 1) {
          currentPreviewDeviceId = videoDevices[1].deviceId;
        } else {
          currentPreviewDeviceId = null;
        }
      });
    } catch (err) {
      console.error("Error enumerating video devices:", err);
    }
  }

  function populateCameraSelect(selectId, callback) {
    const select = document.getElementById(selectId);
    if (!select) return;
    select.innerHTML = "";
    videoDevices.forEach((device, index) => {
      const option = document.createElement("option");
      option.value = device.deviceId;
      option.text = device.label || `Camera ${index + 1}`;
      select.appendChild(option);
      callback(device);
    });
  }

  // Start live camera feed
  async function startLiveCamera() {
    try {
      const constraints = {
        video: { deviceId: currentLiveDeviceId ? { exact: currentLiveDeviceId } : undefined },
        audio: true
      };
      liveStream = await navigator.mediaDevices.getUserMedia(constraints);
      liveVideo.srcObject = liveStream;
      streamStatus.textContent = "Live Camera On";
    } catch (err) {
      console.error("Error starting live camera:", err);
      streamStatus.textContent = "Live Camera Off";
    }
  }

  // Start preview camera feed (alternate camera)
  async function startPreviewCamera() {
    if (!currentPreviewDeviceId) {
      previewVideo.style.display = "none";
      document.getElementById("noPreviewText").style.display = "block";
      return;
    }
    try {
      const constraints = {
        video: { deviceId: { exact: currentPreviewDeviceId } },
        audio: false
      };
      previewStream = await navigator.mediaDevices.getUserMedia(constraints);
      previewVideo.srcObject = previewStream;
      document.getElementById("noPreviewText").style.display = "none";
    } catch (err) {
      console.error("Error starting preview camera:", err);
      previewVideo.style.display = "none";
      document.getElementById("noPreviewText").style.display = "block";
    }
  }

  // Switch to screen sharing for live feed
  async function switchToScreenShare() {
    try {
      const displayStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
      liveStream = displayStream;
      liveVideo.srcObject = liveStream;
      streamStatus.textContent = "Screen Shared";
    } catch (err) {
      console.error("Error switching to screen share:", err);
    }
  }

  function stopLiveCamera() {
    if (liveStream) {
      liveStream.getTracks().forEach(track => track.stop());
      liveStream = null;
      streamStatus.textContent = "Live Camera Off";
    }
  }

  // Recording logic using MediaRecorder
  function startRecording() {
    if (!liveStream) {
      alert("Start a live feed before recording.");
      return;
    }
    recordedChunks = [];
    mediaRecorder = new MediaRecorder(liveStream, { mimeType: 'video/webm; codecs=vp9' });
    mediaRecorder.ondataavailable = (event) => {
      if (event.data.size > 0) recordedChunks.push(event.data);
    };
    mediaRecorder.onstop = uploadRecording;
    mediaRecorder.start();
    startRecordBtn.disabled = true;
    stopRecordBtn.disabled = false;
    alert("Recording started!");
  }

  async function uploadRecording() {
    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    recordedChunks = [];
    const formData = new FormData();
    formData.append("video_file", blob, `recorded_${sessionUuid}.webm`);
    try {
      const response = await fetch("{% url 'streaming:upload_recorded' %}", {
        method: "POST",
        body: formData,
      });
      if (!response.ok) throw new Error(`Upload failed: ${response.status}`);
      const data = await response.json();
      alert("Recording uploaded successfully!");
    } catch (error) {
      console.error("Error uploading recording:", error);
      alert("Failed to upload recording.");
    }
    startRecordBtn.disabled = false;
    stopRecordBtn.disabled = true;
  }

  function stopRecording() {
    if (!mediaRecorder) {
      alert("No recording in progress.");
      return;
    }
    mediaRecorder.stop();
  }

  // Chat functions
  async function fetchChatMessages() {
    try {
      const response = await fetch(`/streaming/fetch_chat_messages/?session_uuid=${sessionUuid}`);
      if (!response.ok) throw new Error("Failed to fetch chat messages");
      const messages = await response.json();
      displayChatMessages(messages);
    } catch (err) {
      console.error("Chat fetch error:", err);
    }
  }

  function displayChatMessages(messages) {
    if (!messages.length) {
      chatContainer.innerHTML = "<p class='text-muted'>No messages yet.</p>";
      return;
    }
    let html = "";
    messages.forEach(msg => {
      html += `<div><strong>${msg.user}:</strong> ${msg.text}</div>`;
    });
    chatContainer.innerHTML = html;
  }

  async function sendChat() {
    const msg = chatMessage.value.trim();
    if (!msg) return;
    try {
      const response = await fetch("/streaming/send_chat_message/", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ session_uuid: sessionUuid, text: msg }),
      });
      if (!response.ok) throw new Error("Error sending chat message");
      chatMessage.value = "";
      fetchChatMessages();
    } catch (error) {
      console.error("Error sending chat message:", error);
    }
  }

  // On page load, get devices and start live & preview cameras
  window.addEventListener("load", async () => {
    await getVideoDevices();
    await startLiveCamera();
    await startPreviewCamera();
    if (!{{ record_mode|yesno:"true,false" }}) {
      setInterval(fetchChatMessages, 5000);
    }
  });

  // Event Listeners for camera controls
  stopLiveCamBtn.addEventListener("click", stopLiveCamera);
  startLiveCamBtn.addEventListener("click", startLiveCamera);
  switchScreenBtn.addEventListener("click", switchToScreenShare);
  adjustLayoutBtn.addEventListener("click", () => {
    // Implement layout adjustment logic here
    alert("Adjust Layout functionality coming soon.");
  });

  // Recording event listeners
  startRecordBtn.addEventListener("click", startRecording);
  stopRecordBtn.addEventListener("click", stopRecording);

  // Chat event listeners
  if (refreshChatBtn) refreshChatBtn.addEventListener("click", fetchChatMessages);
  if (sendChatBtn) sendChatBtn.addEventListener("click", sendChat);
</script>
{% endblock %}
